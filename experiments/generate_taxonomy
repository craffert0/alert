#! /opt/homebrew/bin/python3

# SPDX-License-Identifier: GPL-2.0-or-later
# Copyright (C) 2025 Colin Rafferty <colin@rafferty.net>

import datetime
import json
import sys
from server import Server


def taxoo():
    server = Server()
    return server.get("ref/taxonomy/ebird")


def get_families(taxon):
    d = dict()
    for x in taxon:
        d[x.get("familyCode", "unknown")] = [x["taxonOrder"],
                                             x.get("familyComName", "Others")]
    return [[x[0], x[1][1]] for x in sorted(d.items(), key=lambda i: i[1][0])]


def generate_families(fp, families):
    print(f"// Generated {datetime.datetime.now()}", file=fp)
    print(f"", file=fp)
    print("public enum eBirdFamily: String {", file=fp)
    for kv in families:
        print(f"    case {kv[0]}", file=fp)
    print("}", file=fp)
    print("", file=fp)
    print("extension eBirdFamily {", file=fp)
    print("    var sortKey: Int {", file=fp)
    print("        switch self {", file=fp)
    i = 0
    for kv in families:
        print(f"        case .{kv[0]}: {i}", file=fp)
        i += 1
    print("        }", file=fp)
    print("    }", file=fp)
    print("}", file=fp)
    print("", file=fp)
    print("extension eBirdFamily {", file=fp)
    print("    public var comName: String {", file=fp)
    print("        switch self {", file=fp)
    for kv in families:
        print(f"        case .{kv[0]}: \"{kv[1]}\"", file=fp)
    print("        }", file=fp)
    print("    }", file=fp)
    print("}", file=fp)


def main(argv):
    everything = taxoo()
    with open(argv[1], mode="w") as fp:
        generate_families(fp, get_families(everything))

    taxon = [
        {
            "speciesCode": x["speciesCode"],
            "comName": x["comName"],
            "taxonOrder": x["taxonOrder"],
            "familyCode": x.get("familyCode", "unknown"),
        }
        for x in everything
    ]
    print(
        json.dumps(
            sorted(taxon, key=lambda x: x["speciesCode"]),
            separators=(",", ":"),
        )
    )


if __name__ == "__main__":
    main(sys.argv)
